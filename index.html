<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Catatan Anggaran Sederhana 💰</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');

        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #FF9800; /* Orange */
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333;
            --income-color: #2196F3; /* Blue */
            --expense-color: #F44336; /* Red */
            --tab-height: 50px; 
            --shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08); 
            --shadow-deep: 0 8px 18px rgba(0, 0, 0, 0.15); 
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding-bottom: calc(var(--tab-height) + 10px + env(safe-area-inset-bottom)); 
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
            font-weight: 700;
        }

        /* --- TAB NAVIGATION (BOTTOM BAR) --- */
        #tabs {
            position: fixed; 
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            
            display: flex;
            justify-content: space-around;
            align-items: center;
            
            background-color: var(--card-background);
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.1); 
            height: var(--tab-height); 
            
            width: 100%;
            max-width: 600px; 
            margin: 0 auto;
            box-sizing: border-box;
            
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab-btn {
            flex-grow: 1;
            padding: 2px 5px; 
            text-align: center;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 13px; 
            font-weight: 500;
            color: #777;
            border-radius: 8px;
            transition: all 0.2s ease-out; 
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: center;
            user-select: none;
        }

        .tab-btn.active {
            color: var(--primary-color);
            font-weight: 600;
            transform: scale(1.05); 
        }

        .tab-btn:hover {
            color: var(--secondary-color);
        }

        .tab-btn span {
            font-size: 1.2em; 
            line-height: 1;
            margin-bottom: 1px; 
        }

        /* --- View Management --- */
        .view-content {
            display: none; 
            opacity: 0; 
            transition: opacity 0.3s ease-in-out;
        }

        .view-content.active {
            display: block; 
            opacity: 1;
        }
        
        /* --- Input Form Styling --- */
        #budget-form {
            background-color: var(--card-background);
            padding: 25px;
            border-radius: 15px;
            box-shadow: var(--shadow-deep);
            margin-bottom: 30px;
            border-left: 5px solid var(--primary-color);
            transition: box-shadow 0.3s ease; 
        }

        #budget-form:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--text-color);
        }

        input[type="text"], 
        input[type="date"],
        input[type="password"],
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        #amount {
            font-weight: 600;
            text-align: right;
        }

        input:focus, select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 5px rgba(76, 175, 80, 0.5); 
        }

        /* Radio Buttons */
        .radio-group {
            display: flex;
            gap: 15px;
            margin-top: 5px;
        }

        .radio-group input[type="radio"] {
            display: none;
        }

        .radio-group label {
            background-color: #eee;
            color: var(--text-color);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s, box-shadow 0.2s; 
            font-weight: 400;
            user-select: none;
        }

        /* Masuk (default) color */
        .radio-group input[type="radio"]:checked + label {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
            transform: scale(1.05);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.2); 
        }
        
        /* KELUAR color override */
        #keluar:checked + label {
            background-color: var(--expense-color);
        }

        button.submit-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s; 
            box-shadow: 0 4px 8px rgba(255, 152, 0, 0.4);
        }

        button.submit-btn:hover {
            background-color: #e68900;
            transform: translateY(-3px); 
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.6);
        }
        
        button.submit-btn:active {
             transform: translateY(-1px); 
        }
        
        /* RESET PIN BUTTON STYLING (NEW) */
        #reset-pin-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 0.9em;
            margin-top: 15px;
            cursor: pointer;
            transition: color 0.2s;
            text-decoration: underline;
        }
        #reset-pin-btn:hover {
            color: var(--expense-color);
        }
        
        /* WA Share Button style override */
        button.share-wa-btn:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            box-shadow: none !important;
            transform: none !important;
        }

        /* --- DAILY SUMMARY STYLING --- */
        #daily-summary-box {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 15px;
            box-shadow: var(--shadow-light);
            margin-bottom: 25px;
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
            text-align: center;
            border-top: 5px solid var(--secondary-color);
        }

        /* --- LIST & ITEM STYLING --- */
        #notes-list {
            list-style: none;
            padding: 0;
        }

        .note-item {
            background-color: var(--card-background);
            margin-bottom: 12px;
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 5px solid;
            transition: transform 0.2s ease-out, box-shadow 0.2s, opacity 0.3s; 
        }

        .note-item:hover {
            transform: translateY(-2px); 
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .note-item.masuk {
            border-left-color: var(--income-color);
        }

        .note-item.keluar {
            border-left-color: var(--expense-color);
        }

        .delete-btn {
            background: none;
            border: none;
            color: #aaa;
            font-size: 1.4em; 
            cursor: pointer;
            transition: color 0.2s, transform 0.1s;
        }

        .delete-btn:hover {
            color: var(--expense-color);
            transform: scale(1.1); 
        }

        /* --- MONTHLY SUMMARY & SETTINGS STYLING --- */
        #monthly-list {
            list-style: none;
            padding: 0;
        }

        .monthly-card {
            background-color: var(--card-background);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--shadow-light);
            margin-bottom: 15px;
            border-left: 5px solid var(--secondary-color);
            transition: transform 0.2s;
        }

        .monthly-card:hover {
            transform: translateX(5px);
        }


        /* Remaining styles */
        .summary-card p {
            margin: 0;
            font-size: 0.9em;
            font-weight: 600;
            color: #777;
        }

        .summary-amount {
            font-size: 1.2em;
            font-weight: 700;
            margin-top: 5px;
        }

        #daily-total-income .summary-amount {
            color: var(--income-color);
        }

        #daily-total-expense .summary-amount {
            color: var(--expense-color);
        }
        
        #cumulative-balance {
            grid-column: 1 / -1; 
            background-color: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            margin-top: 10px;
            margin-bottom: 25px; 
            text-align: center;
            box-shadow: var(--shadow-light);
        }
        
        #cumulative-balance .summary-amount {
             font-size: 1.5em;
             color: white;
        }
        
        .note-details {
            flex-grow: 1;
        }

        .note-type {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        
        .note-group {
            font-size: 0.85em; 
            color: #888; 
            margin-bottom: 3px;
        }

        .note-amount {
            font-size: 1.3em;
            font-weight: 700;
        }

        .note-amount.masuk {
            color: var(--income-color);
        }

        .note-amount.keluar {
            color: var(--expense-color);
        }

        .note-description {
            font-size: 0.9em;
            color: #777;
        }
        
        #empty-message {
            text-align: center;
            color: #999;
            padding: 20px;
            background: var(--card-background);
            border-radius: 10px;
        }

        .month-header {
            font-weight: 700;
            font-size: 1.4em;
            margin-bottom: 10px;
            color: var(--text-color);
            display: block;
            border-bottom: 2px solid #eee;
            padding-bottom: 5px;
        }

        .month-details div {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-size: 1em;
        }
        
        .month-details .balance {
            font-weight: 700;
            font-size: 1.1em;
            padding-top: 8px;
            border-top: 1px dashed #ddd;
            margin-top: 5px;
        }

        .month-details .income { color: var(--income-color); }
        .month-details .expense { color: var(--expense-color); }
        .month-details .positive { color: var(--primary-color); }
        .month-details .negative { color: var(--expense-color); }
        
        /* Custom styling for settings view */
        #export-import-card {
            border-left: 5px solid #2196F3; /* Warna biru untuk manajemen data */
        }
        
        /* WA Setting Card */
        #whatsapp-setting-card {
             border-left: 5px solid #25D366; 
        }

        /* Custom style for small image in list */
        .note-image-icon {
            width: 30px; 
            height: 30px; 
            object-fit: cover; 
            border-radius: 3px; 
            margin-left: 10px; 
            cursor: pointer;
            border: 1px solid #ddd;
            padding: 2px;
            transition: transform 0.1s;
        }
        
        .note-image-icon:hover {
            transform: scale(1.05);
        }
        
    </style>
</head>
<body>

    <div id="auth-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f4f7f6; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;">
        <h2 style="color: var(--primary-color);">Akses Aplikasi Terkunci 🔒</h2>
        <p id="auth-instruction" style="color: #666; margin-bottom: 30px;">Gunakan biometrik untuk membuka.</p>
        
        <button id="biometric-auth-btn" style="padding: 15px 30px; background-color: var(--income-color); color: white; border: none; border-radius: 10px; font-size: 1.1em; cursor: pointer; box-shadow: 0 4px 8px rgba(33, 150, 243, 0.5);">
            Ketuk untuk Autentikasi Biometrik 👆
        </button>
        
        <div id="pin-input-container" style="display: none; margin-top: 20px; width: 80%; max-width: 350px; flex-wrap: wrap; justify-content: center;">
            <div style="display: flex; width: 100%;">
                <input type="password" id="pin-input" placeholder="Masukkan PIN 6 digit" maxlength="6" inputmode="numeric" style="padding: 10px; flex-grow: 1; text-align: center; font-size: 18px; border-radius: 8px 0 0 8px; border: 1px solid #ddd; border-right: none;">
                <button id="pin-submit-btn" style="padding: 10px 20px; background-color: var(--secondary-color); color: white; border: none; border-radius: 0 8px 8px 0; margin-left: -1px; cursor: pointer;">
                    Buka
                </button>
            </div>
            
            <button type="button" id="reset-pin-btn" onclick="handlePinReset()">
                Lupa PIN? Reset PIN & Hapus Data
            </button>
        </div>

        <p id="auth-status" style="margin-top: 20px; color: var(--expense-color); font-weight: 600;">Status: Menunggu...</p>
        <p style="font-size: 0.8em; color: #aaa; max-width: 80%; margin-top: 20px;">
            *Opsi PIN akan muncul jika Biometrik gagal. Reset PIN akan **menghapus semua data** transaksi Anda dan membuat PIN baru.
        </p>
    </div>
    <div class="container">
        <h1>Catatan Anggaran 📝</h1>

        <div id="daily-view" class="view-content active">

            <form id="budget-form">
                <div class="form-group">
                    <label>Tipe Transaksi:</label>
                    <div class="radio-group">
                        <input type="radio" id="masuk" name="type" value="masuk" required checked>
                        <label for="masuk">Masuk ⬆️</label>

                        <input type="radio" id="keluar" name="type" value="keluar" required>
                        <label for="keluar">Keluar ⬇️</label>
                    </div>
                </div>

                <div class="form-group">
                    <label for="date">Tanggal Transaksi:</label>
                    <input type="date" id="date" required>
                </div>

                <div class="form-group">
                    <label for="amount">Jumlah (Rp):</label>
                    <input type="text" id="amount" placeholder="Contoh: 50.000" inputmode="numeric" required>
                </div>

                <div class="form-group">
                    <label for="note">Catatan Singkat:</label>
                    <input type="text" id="note" placeholder="Contoh: Gaji bulan ini / Beli kopi" required>
                </div>

                <div class="form-group">
                    <label for="group">Grup Transaksi:</label>
                    <select id="group" required>
                        <option value="bulanan">Uang Bulanan 🗓️</option>
                        <option value="tabungan">Tabungan 🏦</option>
                    </select>
                </div>
                <div class="form-group" style="border: 1px dashed #ddd; padding: 10px; border-radius: 8px; margin-top: 20px;">
                    <label style="font-weight: 400; color: #555;">Bukti Transaksi (Opsional):</label>
                    
                    <input type="file" id="image-input" accept="image/*" style="display: none;">
                    
                    <button type="button" class="submit-btn" id="capture-image-btn" style="background-color: #007bff; font-size: 16px; padding: 8px; margin-bottom: 10px;" onclick="document.getElementById('image-input').click()">
                        Tambah Foto 📸
                    </button>

                    <div id="image-preview-container" style="display: none; text-align: center; margin-top: 10px;">
                        <img id="image-preview" src="" style="max-width: 100%; max-height: 150px; border-radius: 5px; margin-bottom: 5px;">
                        <button type="button" onclick="removeImage()" style="color: var(--expense-color); background: none; border: none; font-size: 0.9em; cursor: pointer;">Hapus Foto 🗑️</button>
                    </div>
                </div>
                <button type="submit" class="submit-btn" style="margin-top: 20px;">Tambahkan Catatan ✨</button>
            </form>

            <div id="daily-summary-box">
                <div id="daily-total-income" class="summary-card">
                    <p>Total Pemasukan</p>
                    <div class="summary-amount">Rp 0</div>
                </div>
                <div id="daily-total-expense" class="summary-card">
                    <p>Total Pengeluaran</p>
                    <div class="summary-amount">Rp 0</div>
                </div>
            </div>

            <div class="form-group" style="display: flex; gap: 10px; align-items: center; margin-bottom: 25px;">
                <label for="type-filter" style="margin-bottom: 0;">Filter Tipe:</label>
                <select id="type-filter" style="flex-grow: 1; padding: 10px; border-radius: 8px;">
                    <option value="all">Semua Tipe</option>
                    <option value="masuk">Masuk</option>
                    <option value="keluar">Keluar</option>
                </select>
            </div>
            
            <h2>Daftar Catatan 👇</h2>
            <p id="empty-message" style="display: none;">Belum ada catatan. Tambahkan satu di atas! 👆</p>
            <ul id="notes-list">
            </ul>
        </div>
        
        <div id="monthly-summary-view" class="view-content">
            
            <div id="cumulative-balance" class="summary-card">
                <p>Sisa Saldo Kumulatif</p>
                <div class="summary-amount">Rp 0</div>
            </div>

            <button type="button" class="submit-btn" style="background-color: var(--primary-color); margin-bottom: 20px;" onclick="exportMonthlySummary()">
                Ekspor Ringkasan Bulanan (CSV) 💾
            </button>
            <h2>Ringkasan Transaksi 🗓️</h2>
            <p id="monthly-empty-message" style="text-align: center; color: #999; padding: 20px; background: var(--card-background); border-radius: 10px; display: none;">Belum ada data untuk ringkasan bulanan.</p>
            <ul id="monthly-list">
                </ul>
        </div>
        
        <div id="settings-view" class="view-content">
            <h2>Pengaturan Data ⚙️</h2>
            <p style="color: #777; margin-top: -10px; margin-bottom: 25px;">Kelola dan migrasi data transaksi Anda.</p>
            
            <div id="whatsapp-setting-card" class="monthly-card" style="border-left: 5px solid #25D366;">
                <span class="month-header">Pengaturan Berbagi WhatsApp 📱</span>
                <form id="whatsapp-setting-form">
                    <div class="form-group">
                        <label for="whatsapp-number">Nomor WhatsApp Tujuan (Format Internasional: 628xxxxxxxx):</label>
                        <input type="text" id="whatsapp-number" placeholder="Contoh: 62812345678" inputmode="tel" style="width: 100%;">
                    </div>
                    <button type="submit" class="submit-btn" style="background-color: #25D366; font-size: 16px; padding: 10px;">
                        Simpan Nomor WA
                    </button>
                </form>
            </div>
            <div id="pin-change-card" class="monthly-card" style="border-left: 5px solid #ff5722;">
                <span class="month-header">Ubah PIN Akses</span>
                <form id="pin-change-form">
                    <div class="form-group">
                        <label for="new-pin">PIN Baru (6 Digit Angka):</label>
                        <input type="password" id="new-pin" placeholder="PIN Baru" maxlength="6" inputmode="numeric" required style="width: 100%;">
                    </div>
                    <button type="submit" class="submit-btn" style="background-color: #ff5722; font-size: 16px; padding: 10px;">
                        Simpan PIN Baru
                    </button>
                </form>
            </div>
            <div id="export-import-card" class="monthly-card">
                <span class="month-header">Impor & Ekspor Data Mentah (JSON)</span>
                <p style="font-size: 0.9em; color: #555; margin-bottom: 15px;">Ekspor adalah backup data lengkap Anda (JSON). Impor akan **menimpa** data yang ada.</p>

                <button type="button" class="submit-btn" style="background-color: #555; margin-bottom: 10px;" onclick="exportRawData()">
                    Ekspor Data Mentah (JSON) 📥
                </button>
                
                <label for="import-file" style="margin-top: 20px; font-weight: 600;">Pilih File Data JSON (.json):</label>
                <input type="file" id="import-file" accept=".json" style="padding: 10px 0; display: block; width: 100%;" onchange="importRawData(event)">
            </div>

            <button type="button" class="submit-btn" style="background-color: var(--expense-color); margin-top: 30px;" onclick="clearAllData()">
                HAPUS SEMUA DATA TRANSAKSI 🗑️
            </button>
        </div>
    </div>
    
    <div id="image-modal" style="display:none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.9);">
      <span style="position: absolute; top: 15px; right: 35px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer;" onclick="document.getElementById('image-modal').style.display='none';">&times;</span>
      <img id="modal-image" src="" alt="Bukti Transaksi Penuh" style="margin: auto; display: block; width: 80%; max-width: 700px; max-height: 90vh; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
    </div>
    
    <div id="tabs">
        <button class="tab-btn active" data-tab="daily-view">
            <span>📝</span>
            Catatan
        </button>
        <button class="tab-btn" data-tab="monthly-summary-view">
            <span>📊</span>
            Ringkasan
        </button>
        <button class="tab-btn" data-tab="settings-view">
            <span>⚙️</span>
            Atur
        </button>
    </div>
    <script>
        const form = document.getElementById('budget-form');
        const notesList = document.getElementById('notes-list');
        const emptyMessageDaily = document.getElementById('empty-message');
        const monthlyList = document.getElementById('monthly-list');
        const emptyMessageMonthly = document.getElementById('monthly-empty-message');
        const dateInput = document.getElementById('date');
        const amountInput = document.getElementById('amount'); 
        const typeFilterSelect = document.getElementById('type-filter');
        
        const groupInput = document.getElementById('group'); 

        const totalIncomeEl = document.querySelector('#daily-total-income .summary-amount');
        const totalExpenseEl = document.querySelector('#daily-total-expense .summary-amount');
        const cumulativeBalanceEl = document.querySelector('#cumulative-balance .summary-amount');
        const cumulativeBalanceCard = document.getElementById('cumulative-balance');

        const tabButtons = document.querySelectorAll('.tab-btn');
        const views = document.querySelectorAll('.view-content');

        const imageInput = document.getElementById('image-input');
        const imagePreviewContainer = document.getElementById('image-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const captureImageBtn = document.getElementById('capture-image-btn');
        let currentImageBase64 = null; 
        
        // Auth elements
        const authOverlay = document.getElementById('auth-overlay');
        const biometricAuthBtn = document.getElementById('biometric-auth-btn');
        const authStatus = document.getElementById('auth-status');
        const authInstruction = document.getElementById('auth-instruction');
        const pinInputContainer = document.getElementById('pin-input-container');
        const pinInput = document.getElementById('pin-input');
        const pinSubmitBtn = document.getElementById('pin-submit-btn');
        const appContainer = document.querySelector('.container');
        const tabs = document.getElementById('tabs');
        const pinChangeForm = document.getElementById('pin-change-form'); 
        const resetPinBtn = document.getElementById('reset-pin-btn'); 

        // NEW: WhatsApp elements
        const whatsappSettingForm = document.getElementById('whatsapp-setting-form');
        const whatsappNumberInput = document.getElementById('whatsapp-number');
        let storedWhatsappNumber = localStorage.getItem('whatsappNumber') || '';

        dateInput.valueAsDate = new Date();
        typeFilterSelect.addEventListener('change', loadNotes);

        /* ----------------------
        |  HELPER FUNCTIONS
        | ---------------------- */

        /**
         * Formats a number into Rupiah currency string.
         */
        function formatRupiah(number) {
            const absoluteNumber = Math.abs(number);
            if (isNaN(absoluteNumber)) return '0';
            return new Intl.NumberFormat('id-ID').format(absoluteNumber);
        }
        
        /**
         * Cleans a formatted string back to a raw number.
         */
        function cleanAmount(formattedString) {
            const cleanStr = String(formattedString).replace(/\D/g, ''); 
            return parseInt(cleanStr || '0', 10);
        }

        function changeTab(tabId) {
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-tab') === tabId) {
                    btn.classList.add('active');
                }
            });

            views.forEach(view => {
                view.classList.remove('active');
            });
            const activeView = document.getElementById(tabId);
            if (activeView) {
                setTimeout(() => {
                    activeView.classList.add('active');
                }, 10);
            }
            
            loadNotes(); 
        }

        tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                changeTab(btn.getAttribute('data-tab'));
            });
        });

        /* ----------------------
        |  INPUT & IMAGE LOGIC 
        | ---------------------- */

        amountInput.addEventListener('input', (e) => {
            const cursorPosition = amountInput.selectionStart;
            const oldValue = e.target.value;
            const rawAmount = cleanAmount(oldValue);
            const formattedValue = formatRupiah(rawAmount);

            e.target.value = formattedValue;
            
            const diff = formattedValue.length - oldValue.length;
            if (cursorPosition + diff >= 0) {
                 amountInput.setSelectionRange(cursorPosition + diff, cursorPosition + diff);
            }
        });

        amountInput.addEventListener('blur', (e) => {
            const rawAmount = cleanAmount(e.target.value);
            if (rawAmount > 0) {
                e.target.value = formatRupiah(rawAmount);
            } else {
                 e.target.value = ''; 
            }
        });

        function compressImage(file, quality = 0.7) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height *= MAX_WIDTH / width;
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width *= MAX_HEIGHT / height;
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressedBase64 = canvas.toDataURL('image/jpeg', quality);
                        resolve(compressedBase64);
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        imageInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (file) {
                
                if (file.size > 1024 * 5000) { 
                     alert('File gambar terlalu besar. Batas maksimal file mentah adalah 5MB.');
                     imageInput.value = '';
                     removeImage();
                     return;
                }

                try {
                    captureImageBtn.textContent = 'Memproses...';
                    captureImageBtn.disabled = true;

                    const compressedBase64 = await compressImage(file, 0.7); 

                    currentImageBase64 = compressedBase64;
                    imagePreview.src = currentImageBase64;
                    imagePreviewContainer.style.display = 'block';
                    captureImageBtn.textContent = 'Ganti Foto 🔄';
                    captureImageBtn.style.backgroundColor = '#0056b3';
                    
                } catch(error) {
                    alert('Gagal memproses gambar. Silakan coba gambar lain.');
                    console.error(error);
                    removeImage();
                } finally {
                    captureImageBtn.disabled = false;
                }
                
            } else {
                removeImage();
            }
        });

        window.removeImage = function() {
            currentImageBase64 = null;
            imageInput.value = ''; 
            imagePreview.src = '';
            imagePreviewContainer.style.display = 'none';
            captureImageBtn.textContent = 'Tambah Foto 📸';
            captureImageBtn.style.backgroundColor = '#007bff';
        }

        window.showFullImage = function(base64Data) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            
            modalImage.src = base64Data;
            modal.style.display = 'block';
        }

        /* ----------------------
        |  SUMMARY & RENDER LOGIC
        | ---------------------- */

        function updateDailySummary(allNotes) {
            let totalIncome = 0;
            let totalExpense = 0;

            allNotes.forEach(note => {
                if (note.type === 'masuk') {
                    totalIncome += note.amount;
                } else if (note.type === 'keluar') {
                    totalExpense += note.amount;
                }
            });

            const currentBalance = totalIncome - totalExpense;

            totalIncomeEl.textContent = `Rp ${formatRupiah(totalIncome)}`;
            totalExpenseEl.textContent = `Rp ${formatRupiah(totalExpense)}`;
            
            const balanceSign = currentBalance < 0 ? '-' : '';
            cumulativeBalanceEl.textContent = `${balanceSign} Rp ${formatRupiah(currentBalance)}`;
            
            cumulativeBalanceCard.style.backgroundColor = currentBalance < 0 ? 'var(--expense-color)' : 'var(--primary-color)';
        }

        function createNoteElement(note) {
            const listItem = document.createElement('li');
            listItem.className = `note-item ${note.type}`;
            listItem.dataset.id = note.id;

            const typeLabel = note.type === 'masuk' ? 'Pemasukan' : 'Pengeluaran';
            const sign = note.type === 'masuk' ? '+' : '-';

            const transactionDate = note.date ? new Date(note.date) : new Date(parseInt(note.id)); 
            
            const group = note.group || 'bulanan'; 
            const groupLabel = group === 'tabungan' ? 'Tabungan 🏦' : 'Bulanan 🗓️'; 

            const imageHtml = note.image ? 
                `<img src="${note.image}" alt="Bukti Transaksi" class="note-image-icon" onclick="showFullImage('${note.image}')">` : '';

            listItem.innerHTML = `
                <div class="note-details">
                    <div class="note-type">${typeLabel} (${transactionDate.toLocaleDateString('id-ID')})</div>
                    <div class="note-group">Grup: ${groupLabel}</div> 
                    <div class="note-amount ${note.type}">${sign} Rp ${formatRupiah(note.amount)}</div>
                    <div class="note-description">${note.note}</div>
                </div>
                <div style="display: flex; align-items: center;">
                    ${imageHtml}
                    <button class="delete-btn" onclick="deleteNote('${note.id}')" title="Hapus Catatan" style="margin-left: 10px;">
                        ✖️
                    </button>
                </div>
            `;
            return listItem;
        }

        function calculateMonthlySummary(notes) {
            const monthlyData = {};

            notes.forEach(note => {
                const date = new Date(note.date || parseInt(note.id)); 
                
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0'); 
                const monthKey = `${year}-${month}`;

                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = { income: 0, expense: 0, bulananIncome: 0, bulananExpense: 0, tabunganIncome: 0, tabunganExpense: 0 };
                }
                
                const group = note.group || 'bulanan'; 

                if (note.type === 'masuk') {
                    monthlyData[monthKey].income += note.amount;
                    if (group === 'bulanan') monthlyData[monthKey].bulananIncome += note.amount;
                    if (group === 'tabungan') monthlyData[monthKey].tabunganIncome += note.amount;
                } else {
                    monthlyData[monthKey].expense += note.amount;
                    if (group === 'bulanan') monthlyData[monthKey].bulananExpense += note.amount;
                    if (group === 'tabungan') monthlyData[monthKey].tabunganExpense += note.amount;
                }
            });

            return monthlyData;
        }

        function renderMonthlySummary(monthlyData) {
            monthlyList.innerHTML = '';
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            // Urutkan key dari yang PALING LAMA ke yang PALING BARU (ASCENDING) untuk penghitungan kumulatif
            const monthKeys = Object.keys(monthlyData).sort(); 
            
            if (monthKeys.length === 0) {
                emptyMessageMonthly.style.display = 'block';
                return;
            }
            emptyMessageMonthly.style.display = 'none';
            
            let cumulativeBalance = 0;
            let cumulativeSavingsBalance = 0; 
            
            // Loop pertama untuk menghitung saldo kumulatif
            monthKeys.forEach(key => {
                const data = monthlyData[key];
                const tabunganBalance = data.tabunganIncome - data.tabunganExpense;
                const totalBalance = data.income - data.expense; 

                cumulativeBalance += totalBalance;
                cumulativeSavingsBalance += tabunganBalance;

                // Simpan nilai kumulatif di objek data 
                data.cumulativeBalance = cumulativeBalance;
                data.cumulativeSavingsBalance = cumulativeSavingsBalance;
            });
            
            // Urutkan key dari yang PALING BARU ke yang PALING LAMA (DESCENDING) untuk tampilan
            monthKeys.reverse(); 
            
            // Cek apakah nomor WA sudah disetel
            const isWhatsappSet = storedWhatsappNumber && storedWhatsappNumber.length >= 8;

            monthKeys.forEach(key => {
                const [year, monthIndex] = key.split('-');
                const monthName = monthNames[parseInt(monthIndex, 10) - 1];
                const data = monthlyData[key];
                const balance = data.income - data.expense;

                const bulananBalance = data.bulananIncome - data.bulananExpense;
                const tabunganBalance = data.tabunganIncome - data.tabunganExpense;
                
                // Nilai Kumulatif yang sudah dihitung di loop sebelumnya
                const finalCumulativeBalance = data.cumulativeBalance;
                const finalCumulativeSavingsBalance = data.cumulativeSavingsBalance;


                const listItem = document.createElement('li');
                listItem.className = 'monthly-card';
                listItem.innerHTML = `
                    <span class="month-header">${monthName} ${year}</span>
                    <div class="month-details">
                        <div style="font-weight: 700;">
                            <span>Total Bulanan (Bulan Ini):</span>
                            <span class="${bulananBalance >= 0 ? 'positive' : 'negative'}">${bulananBalance >= 0 ? '+' : ''} Rp ${formatRupiah(bulananBalance)}</span>
                        </div>
                        <div style="padding-left: 10px;">
                            <span>Pemasukan Bulanan:</span>
                            <span class="income">+ Rp ${formatRupiah(data.bulananIncome)}</span>
                        </div>
                        <div style="padding-left: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; margin-bottom: 5px;">
                            <span>Pengeluaran Bulanan:</span>
                            <span class="expense">- Rp ${formatRupiah(data.bulananExpense)}</span>
                        </div>
                        
                        <div style="font-weight: 700;">
                            <span>Total Tabungan (Bulan Ini):</span>
                            <span class="${tabunganBalance >= 0 ? 'positive' : 'negative'}">${tabunganBalance >= 0 ? '+' : ''} Rp ${formatRupiah(tabunganBalance)}</span>
                        </div>
                        <div style="padding-left: 10px;">
                            <span>Masuk Tabungan:</span>
                            <span class="income">+ Rp ${formatRupiah(data.tabunganIncome)}</span>
                        </div>
                        <div style="padding-left: 10px; border-bottom: 1px dashed #ddd; padding-bottom: 10px; margin-bottom: 5px;">
                            <span>Keluar Tabungan:</span>
                            <span class="expense">- Rp ${formatRupiah(data.tabunganExpense)}</span>
                        </div>

                        <div class="balance" style="margin-top: 15px;">
                            <span>**Saldo Total Bulan Ini:**</span>
                            <span class="${balance >= 0 ? 'positive' : 'negative'}">${balance >= 0 ? '+' : ''} Rp ${formatRupiah(balance)}</span>
                        </div>
                        
                        <div class="balance" style="margin-top: 15px;">
                            <span>**Saldo Tabungan Kumulatif:**</span>
                            <span class="${finalCumulativeSavingsBalance >= 0 ? 'positive' : 'negative'}">${finalCumulativeSavingsBalance >= 0 ? '+' : ''} Rp ${formatRupiah(finalCumulativeSavingsBalance)}</span>
                        </div>
                        <div class="balance">
                            <span>**Saldo Total Keseluruhan (Kumulatif):**</span>
                            <span class="${finalCumulativeBalance >= 0 ? 'positive' : 'negative'}">${finalCumulativeBalance >= 0 ? '+' : ''} Rp ${formatRupiah(finalCumulativeBalance)}</span>
                        </div>
                    </div>
                    
                    <button type="button" 
                        class="submit-btn share-wa-btn" 
                        style="margin-top: 15px; background-color: #25D366; font-size: 16px; padding: 10px;" 
                        data-month-key="${key}"
                        ${isWhatsappSet ? '' : 'disabled title="Atur nomor WhatsApp di tab Atur dulu"'}
                        onclick="shareMonthlySummaryToWa(this)">
                        ${isWhatsappSet ? `Bagikan Ringkasan ke WA 💬` : `Setel Nomor WA Dulu!`}
                    </button>
                `;
                monthlyList.appendChild(listItem);
            });
        }


        function loadNotes() {
            const notesJSON = localStorage.getItem('budgetNotes');
            const allNotes = notesJSON ? JSON.parse(notesJSON) : [];
            
            const typeFilter = typeFilterSelect.value;
            let notesToDisplay = allNotes;
            if (typeFilter !== 'all') {
                notesToDisplay = allNotes.filter(note => note.type === typeFilter);
            }

            notesToDisplay.sort((a, b) => parseInt(b.id) - parseInt(a.id));
            
            notesList.innerHTML = ''; 
            if (notesToDisplay.length === 0) {
                emptyMessageDaily.style.display = 'block';
            } else {
                emptyMessageDaily.style.display = 'none';
                notesToDisplay.forEach(note => {
                    notesList.appendChild(createNoteElement(note));
                });
            }
            
            updateDailySummary(allNotes); 

            const monthlyData = calculateMonthlySummary(allNotes);
            renderMonthlySummary(monthlyData);
        }

        function saveNote(newNote) {
            const notesJSON = localStorage.getItem('budgetNotes');
            const notes = notesJSON ? JSON.parse(notesJSON) : [];
            notes.push(newNote);
            localStorage.setItem('budgetNotes', JSON.stringify(notes));
        }
        
        window.deleteNote = function(id) {
            if (!confirm('Hapus Transaksi? Tindakan ini tidak dapat dibatalkan.')) {
                return;
            }

            const notesJSON = localStorage.getItem('budgetNotes');
            let notes = notesJSON ? JSON.parse(notesJSON) : [];
            
            notes = notes.filter(note => note.id !== id);
            
            localStorage.setItem('budgetNotes', JSON.stringify(notes));
            
            const itemToDelete = document.querySelector(`.note-item[data-id="${id}"]`);
            if (itemToDelete) {
                itemToDelete.style.opacity = '0';
                itemToDelete.style.transform = 'translateX(-100%)';
                setTimeout(() => {
                    loadNotes(); 
                }, 250);
            } else {
                loadNotes();
            }
        }

        form.addEventListener('submit', (e) => {
            e.preventDefault();

            const type = document.querySelector('input[name="type"]:checked').value;
            const amount = cleanAmount(amountInput.value); 
            const noteText = document.getElementById('note').value.trim();
            const transactionDate = dateInput.value;
            const group = document.getElementById('group').value; 

            if (amount <= 0 || noteText === '' || transactionDate === '') {
                alert('Mohon isi semua kolom dengan benar (Jumlah harus lebih dari 0 dan tanggal harus dipilih).');
                return;
            }
            
            const currentNotes = JSON.parse(localStorage.getItem('budgetNotes') || '[]');
            const totalIncome = currentNotes.filter(n => n.type === 'masuk').reduce((sum, n) => sum + n.amount, 0);
            const totalExpense = currentNotes.filter(n => n.type === 'keluar').reduce((sum, n) => sum + n.amount, 0);
            const currentBalance = totalIncome - totalExpense;

            if (type === 'keluar') {
                const projectedBalance = currentBalance - amount;
                const warningThreshold = -50000; 
                
                if (projectedBalance < warningThreshold) {
                    const confirmed = confirm(`PERINGATAN! Transaksi ini akan membuat saldo Anda menjadi minus Rp ${formatRupiah(Math.abs(projectedBalance))}.\n\nAnda yakin ingin melanjutkan pencatatan pengeluaran ini?`);
                    if (!confirmed) {
                        return; 
                    }
                }
            }

            const newNote = {
                id: Date.now().toString(), 
                type: type,
                amount: amount,
                note: noteText,
                date: new Date(transactionDate).toISOString(),
                image: currentImageBase64,
                group: group 
            };

            saveNote(newNote);

            form.reset();
            document.getElementById('masuk').checked = true;
            document.getElementById('group').value = 'bulanan'; 
            dateInput.valueAsDate = new Date();
            amountInput.value = ''; 
            typeFilterSelect.value = 'all';

            removeImage(); 

            loadNotes();
            changeTab('daily-view'); 
        });

        /* ----------------------
        |  EXPORT CSV LOGIC 
        | ---------------------- */

        window.exportMonthlySummary = function() {
            const notesJSON = localStorage.getItem('budgetNotes');
            const allNotes = notesJSON ? JSON.parse(notesJSON) : [];

            if (allNotes.length === 0) {
                alert("Tidak ada data transaksi untuk diekspor.");
                return;
            }

            const monthlyData = calculateMonthlySummary(allNotes);
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            
            const monthKeys = Object.keys(monthlyData).sort().reverse(); 
            
            let csvContent = "Bulan,Pemasukan Total (Rp),Pengeluaran Total (Rp),Saldo Bulan Ini (Rp),Pemasukan Bulanan (Rp),Pengeluaran Bulanan (Rp),Pemasukan Tabungan (Rp),Pengeluaran Tabungan (Rp)\n";

            monthKeys.forEach(key => {
                const [year, monthIndex] = key.split('-');
                const monthName = monthNames[parseInt(monthIndex, 10) - 1];
                const data = monthlyData[key];
                const balance = data.income - data.expense;

                const line = `${monthName} ${year},${data.income},${data.expense},${balance},${data.bulananIncome},${data.bulananExpense},${data.tabunganIncome},${data.tabunganExpense}\n`;
                csvContent += line;
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            
            const dateStamp = new Date().toISOString().substring(0, 10);
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", `RingkasanAnggaran_${dateStamp}.csv`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert("Data ringkasan berhasil diekspor ke CSV!");
        }
        
        /* ----------------------
        |  EXPORT/IMPORT RAW DATA & CLEAR (TAB ATUR)
        | ---------------------- */

        window.exportRawData = function() {
            const notesJSON = localStorage.getItem('budgetNotes');
            const allNotes = notesJSON ? JSON.parse(notesJSON) : [];

            if (allNotes.length === 0) {
                return null; 
            }

            const blob = new Blob([notesJSON], { type: 'application/json' });
            const link = document.createElement("a");
            const dateStamp = new Date().toISOString().substring(0, 10);
            
            link.setAttribute("href", URL.createObjectURL(blob));
            link.setAttribute("download", `DataAnggaranMentah_${dateStamp}.json`);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            if (document.getElementById('settings-view').classList.contains('active')) {
                 alert("Data mentah (JSON) berhasil diekspor! Gunakan file ini untuk Impor data di perangkat lain.");
            }

            return notesJSON;
        }

        window.importRawData = function(event) {
            const file = event.target.files[0];
            if (!file) {
                return;
            }

            if (!confirm('PERINGATAN! Impor data akan MENIMPA SEMUA data transaksi yang ada saat ini. Lanjutkan?')) {
                event.target.value = ''; 
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedNotes) || (importedNotes.length > 0 && !importedNotes[0].id)) {
                        throw new Error("Struktur file JSON tidak valid.");
                    }
                    
                    localStorage.setItem('budgetNotes', JSON.stringify(importedNotes));
                    alert(`Data (${importedNotes.length} catatan) berhasil diimpor dan menimpa data lama!`);
                    loadNotes();
                    changeTab('daily-view'); 
                } catch (error) {
                    alert('Gagal mengimpor file. Pastikan file berformat JSON yang benar. Error: ' + error.message);
                } finally {
                    event.target.value = '';
                }
            };
            reader.readAsText(file);
        }

        window.clearAllData = function() {
            if (confirm('SANGAT PENTING: Anda yakin ingin MENGHAPUS SEMUA DATA TRANSAKSI Anda? Tindakan ini tidak dapat dibatalkan. Pastikan Anda sudah melakukan Ekspor (Backup)!')) {
                localStorage.removeItem('budgetNotes');
                alert('Semua data transaksi telah dihapus!');
                loadNotes();
                changeTab('daily-view');
            }
        }
        
        /* ----------------------
        |  WHATSAPP SHARING LOGIC
        | ---------------------- */
        
        whatsappSettingForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const newNumber = whatsappNumberInput.value.trim().replace(/[^0-9]/g, ''); 

            if (!newNumber || newNumber.length < 8) {
                alert('Mohon masukkan Nomor WhatsApp yang valid (minimal 8 digit).');
                return;
            }
            
            storedWhatsappNumber = newNumber;
            localStorage.setItem('whatsappNumber', storedWhatsappNumber);
            alert('Nomor WhatsApp berhasil disimpan!');
            
            loadNotes(); 
        });
        
        /**
         * Mengambil dan memformat detail transaksi untuk bulan tertentu.
         */
        function getMonthlyTransactionDetails(monthKey, allNotes) {
            const notesInMonth = allNotes.filter(note => {
                // Konversi ISO string (note.date) atau timestamp (note.id) ke format YYYY-MM
                const date = new Date(note.date || parseInt(note.id)); 
                const year = date.getFullYear();
                const month = (date.getMonth() + 1).toString().padStart(2, '0');
                const noteMonthKey = `${year}-${month}`;
                return noteMonthKey === monthKey;
            });

            // Urutkan catatan berdasarkan tanggal dan ID (terbaru di atas)
            notesInMonth.sort((a, b) => {
                const dateA = new Date(a.date || parseInt(a.id));
                const dateB = new Date(b.date || parseInt(b.id));
                return dateB.getTime() - dateA.getTime();
            });

            let detailMessage = "*Detail Transaksi:*\n";

            if (notesInMonth.length === 0) {
                return detailMessage + "   - Tidak ada catatan detail.";
            }

            notesInMonth.forEach(note => {
                const sign = note.type === 'masuk' ? '+' : '-';
                const groupLabel = note.group === 'tabungan' ? '(Tabungan)' : '(Bulanan)';
                const date = new Date(note.date || parseInt(note.id));
                const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                const line = `   [${formattedDate}] *${note.note}* ${groupLabel}: ${sign}Rp ${formatRupiah(note.amount)}\n`;
                detailMessage += line;
            });
            
            return detailMessage;
        }

        /**
         * Memformat pesan dan memicu berbagi ke WhatsApp.
         */
        window.shareMonthlySummaryToWa = function(buttonElement) {
            if (!storedWhatsappNumber || storedWhatsappNumber.length < 8) {
                alert('Nomor WhatsApp tujuan belum diatur. Silakan atur di tab "Atur" terlebih dahulu.');
                return;
            }

            const monthKey = buttonElement.getAttribute('data-month-key');
            
            // Ambil semua data ringkasan
            const notesJSON = localStorage.getItem('budgetNotes');
            const allNotes = notesJSON ? JSON.parse(notesJSON) : [];
            const monthlyData = calculateMonthlySummary(allNotes);
            
            const data = monthlyData[monthKey];
            if (!data) return; 
            
            // 1. Dapatkan Detail Transaksi
            const transactionDetails = getMonthlyTransactionDetails(monthKey, allNotes);

            // Ulangi logika perhitungan kumulatif untuk mendapatkan nilai final
            const monthKeysOrdered = Object.keys(monthlyData).sort();
            let currentCumulativeBalance = 0;
            let currentCumulativeSavingsBalance = 0;
            
            for (const key of monthKeysOrdered) {
                 const currentData = monthlyData[key];
                 const totalBalance = currentData.income - currentData.expense;
                 const tabunganBalance = currentData.tabunganIncome - currentData.tabunganExpense;
                 
                 currentCumulativeBalance += totalBalance;
                 currentCumulativeSavingsBalance += tabunganBalance;
                 
                 if (key === monthKey) break; 
            }

            const [year, monthIndex] = monthKey.split('-');
            const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            const monthName = monthNames[parseInt(monthIndex, 10) - 1];

            const balance = data.income - data.expense;
            const bulananBalance = data.bulananIncome - data.bulananExpense;
            const tabunganBalance = data.tabunganIncome - data.tabunganExpense;

            // Membuat pesan format
            const message = `*📊 Ringkasan Anggaran Bulan ${monthName} ${year}*\n\n` +
                            `➡️ *Pemasukan Total:* +Rp ${formatRupiah(data.income)}\n` +
                            `⬅️ *Pengeluaran Total:* -Rp ${formatRupiah(data.expense)}\n` +
                            `---------------------------------\n` +
                            `*Saldo Bulan Ini:* ${balance >= 0 ? '+' : ''}Rp ${formatRupiah(balance)}\n\n` +
                            
                            `*Detail Grup Bulanan* (Masuk: +Rp ${formatRupiah(data.bulananIncome)}, Keluar: -Rp ${formatRupiah(data.bulananExpense)})\n` +
                            `   > *Saldo Bulanan:* ${bulananBalance >= 0 ? '+' : ''}Rp ${formatRupiah(bulananBalance)}\n\n` +
                            
                            `*Detail Grup Tabungan* (Masuk: +Rp ${formatRupiah(data.tabunganIncome)}, Keluar: -Rp ${formatRupiah(data.tabunganExpense)})\n` +
                            `   > *Saldo Tabungan Bulan Ini:* ${tabunganBalance >= 0 ? '+' : ''}Rp ${formatRupiah(tabunganBalance)}\n` +
                            `   > *Saldo Tabungan Kumulatif:* ${currentCumulativeSavingsBalance >= 0 ? '+' : ''}Rp ${formatRupiah(currentCumulativeSavingsBalance)}\n\n` +

                            `*Saldo Total Kumulatif Keseluruhan:* ${currentCumulativeBalance >= 0 ? '+' : ''}Rp ${formatRupiah(currentCumulativeBalance)}\n` +
                            `=================================\n\n` +
                            
                            `${transactionDetails}\n` + 
                            `=================================\n` +
                            `_Dibagikan dari Catatan Anggaran Sederhana_ 📝`;

            // Membuat URL WhatsApp
            const encodedMessage = encodeURIComponent(message);
            const waUrl = `https://wa.me/${storedWhatsappNumber}?text=${encodedMessage}`;
            
            window.open(waUrl, '_blank');
        }


        /* ----------------------
        |  PIN MANAGEMENT & AUTHENTICATION LOGIC
        | ---------------------- */

        function generatePin() {
            let pin = '';
            for (let i = 0; i < 6; i++) {
                pin += Math.floor(Math.random() * 10);
            }
            return pin;
        }

        function getPin() {
            return localStorage.getItem('appPin');
        }

        function setPin(newPin) {
            localStorage.setItem('appPin', newPin);
        }
        
        function switchToPinMode(message) {
            authInstruction.textContent = message || "Biometrik gagal/dibatalkan. Masukkan PIN Anda.";
            biometricAuthBtn.style.display = 'none';
            pinInputContainer.style.display = 'flex';
            pinInput.focus();
            authStatus.textContent = "Mode PIN Cadangan Aktif"; 
            authStatus.style.color = '#FF9800';
        }

        function validatePin() {
            const enteredPin = pinInput.value.trim();
            const storedPin = getPin();

            if (enteredPin.length === 6 && enteredPin === storedPin) {
                authStatus.textContent = "PIN Benar! Membuka kunci...";
                authStatus.style.color = 'var(--primary-color)';
                setTimeout(unlockApp, 500);
            } else {
                authStatus.textContent = "PIN salah. Coba lagi.";
                authStatus.style.color = 'var(--expense-color)';
                pinInput.value = '';
                pinInput.focus();
            }
        }
        
        window.handlePinReset = function() {
            const confirmReset = confirm(
                "PERINGATAN! Anda akan mereset PIN. Tindakan ini akan:\n" +
                "1. **Mengekspor** data transaksi ke file backup JSON (untuk pengamanan data Anda).\n" +
                "2. **Menghapus SEMUA** data transaksi yang ada (termasuk PIN lama) dari aplikasi.\n\n" +
                "Lanjutkan?"
            );

            if (!confirmReset) {
                return;
            }
            
            exportRawData(); 
            
            localStorage.removeItem('budgetNotes');
            localStorage.removeItem('appPin'); 
            localStorage.removeItem('whatsappNumber'); // Hapus juga nomor WA lama

            const newPin = generatePin();
            setPin(newPin);
            
            // Reset WA input to clear 
            storedWhatsappNumber = '';
            if (whatsappNumberInput) whatsappNumberInput.value = '';

            authOverlay.style.backgroundColor = '#fff3e0'; 
            authInstruction.textContent = `RESET BERHASIL. PIN BARU Anda adalah: ${newPin}.`;
            authStatus.textContent = "Data lama sudah dihapus. Silakan gunakan PIN baru di atas untuk masuk.";
            authStatus.style.color = 'var(--expense-color)';
            
            pinInput.value = newPin;
            pinInput.focus();
            
            alert(`PENTING! PIN baru Anda adalah: ${newPin}\n\nData lama di aplikasi telah dihapus. Harap catat PIN baru ini dan cek folder download Anda untuk file backup data (JSON).`);
        }
        
        pinSubmitBtn.addEventListener('click', validatePin);
        pinInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validatePin();
            }
        });
        pinInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.replace(/\D/g, '').substring(0, 6);
        });

        pinChangeForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const newPinInput = document.getElementById('new-pin');
            const newPin = newPinInput.value;
            
            if (newPin.length !== 6 || !/^\d{6}$/.test(newPin)) {
                alert('PIN harus berupa 6 digit angka.');
                return;
            }
            
            setPin(newPin);
            alert('PIN Akses berhasil diubah!');
            pinChangeForm.reset();
        });


        function unlockApp() {
            authOverlay.style.display = 'none';
            appContainer.style.display = 'block';
            tabs.style.display = 'flex';
            loadNotes();
        }

        async function authenticateBiometric() {
            if (!window.PublicKeyCredential) {
                switchToPinMode("Browser Anda tidak mendukung Autentikasi Biometrik.");
                return; 
            }

            authStatus.textContent = "Mencoba otentikasi biometrik...";
            authStatus.style.color = 'var(--secondary-color)';
            biometricAuthBtn.disabled = true;

            try {
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge); 

                const credentialRequestOptions = {
                    challenge: challenge,
                    allowCredentials: [], 
                    timeout: 60000,
                    userVerification: 'required', 
                    rpId: window.location.hostname || 'localhost',
                };

                await navigator.credentials.get({
                    publicKey: credentialRequestOptions
                });

                authStatus.textContent = "Autentikasi Berhasil! Membuka kunci...";
                authStatus.style.color = 'var(--primary-color)';
                setTimeout(unlockApp, 500);

            } catch (error) {
                console.error("Autentikasi Biometrik Gagal:", error);
                biometricAuthBtn.disabled = false;
                switchToPinMode();
            }
        }


        // --- Initial Load (Setup PIN & Start Auth) ---
        document.addEventListener('DOMContentLoaded', () => {
             // 1. Setup PIN jika belum ada
             if (!getPin()) {
                const defaultPin = generatePin();
                setPin(defaultPin);
                
                alert(`SELAMAT DATANG! Ini adalah PIN akses default Anda: ${defaultPin}\n\nCATAT PIN INI! Anda dapat mengubahnya di tab 'Atur'.`);
             }
             
             // 2. Sembunyikan konten utama dan mulai autentikasi
             appContainer.style.display = 'none';
             tabs.style.display = 'none';
             
             // 3. Load WA Number to Input
             if (whatsappNumberInput) whatsappNumberInput.value = storedWhatsappNumber;

             setTimeout(authenticateBiometric, 500); 
        });
    </script>

</body>
</html>
